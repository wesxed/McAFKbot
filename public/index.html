<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, user-scalable=no">
  <title>CS Mobile - Tactical Warfare</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; -webkit-user-select: none; user-select: none; }
    html, body { width: 100%; height: 100%; overflow: hidden; }
    body { font-family: 'Arial', sans-serif; background: #000; }
    #canvas { display: block; width: 100%; height: 100%; touch-action: none; }
    
    #hud {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      height: 100px;
      background: linear-gradient(to top, rgba(0,0,0,0.9), rgba(0,0,0,0.3));
      color: #fff;
      font-family: 'Courier New', monospace;
      display: flex;
      justify-content: space-between;
      align-items: flex-end;
      padding: 0 20px 10px 20px;
      border-top: 1px solid rgba(255,255,0,0.2);
    }

    .hud-left, .hud-center, .hud-right {
      display: flex;
      flex-direction: column;
      gap: 5px;
    }

    .hud-item {
      font-size: 14px;
      color: #ffff00;
      text-shadow: 0 0 5px rgba(255,255,0,0.5);
    }

    .ammo-display {
      font-size: 24px;
      font-weight: bold;
      color: #ffff00;
    }

    .weapon-name {
      font-size: 12px;
      color: #aaa;
    }

    #teamList {
      position: absolute;
      top: 10px;
      right: 10px;
      background: rgba(0, 0, 0, 0.8);
      border: 1px solid rgba(255, 255, 0, 0.3);
      padding: 10px;
      color: #fff;
      font-family: 'Courier New', monospace;
      font-size: 12px;
      max-width: 200px;
    }

    .team-player {
      padding: 3px;
      margin: 2px 0;
      border-left: 3px solid #ffff00;
      padding-left: 6px;
    }

    .team-player.dead {
      opacity: 0.5;
      color: #ff6666;
    }

    #topbar {
      position: absolute;
      top: 10px;
      left: 10px;
      right: 10px;
      display: flex;
      justify-content: space-between;
      color: #fff;
      font-family: 'Courier New', monospace;
      font-size: 14px;
    }

    .score-display {
      background: rgba(0, 0, 0, 0.7);
      padding: 5px 15px;
      border: 1px solid rgba(255, 255, 0, 0.3);
      text-align: center;
    }

    .score-team-a { color: #ff6666; }
    .score-team-b { color: #6699ff; }

    .timer {
      background: rgba(0, 0, 0, 0.7);
      padding: 5px 15px;
      border: 1px solid rgba(255, 255, 0, 0.3);
    }

    #crosshair {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 30px;
      height: 30px;
      border: 2px solid rgba(255, 255, 0, 0.6);
      border-radius: 50%;
      z-index: 50;
      pointer-events: none;
    }

    .crosshair-dot {
      width: 2px;
      height: 2px;
      background: rgba(255, 255, 0, 0.8);
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
    }

    #minimap {
      position: absolute;
      top: 50px;
      right: 10px;
      width: 140px;
      height: 140px;
      background: rgba(0, 0, 0, 0.8);
      border: 1px solid rgba(255, 255, 0, 0.3);
    }

    #controls {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      height: 100px;
      display: flex;
      justify-content: space-between;
      align-items: flex-end;
      padding: 10px;
      gap: 10px;
    }

    .joystick-area {
      width: 90px;
      height: 90px;
      background: rgba(0, 0, 0, 0.6);
      border: 1px solid rgba(255, 255, 0, 0.3);
      position: relative;
      border-radius: 10px;
    }

    .joystick-center {
      position: absolute;
      width: 25px;
      height: 25px;
      background: rgba(255, 255, 0, 0.4);
      border-radius: 50%;
      border: 1px solid rgba(255, 255, 0, 0.6);
    }

    .button-area {
      display: flex;
      gap: 8px;
      margin-bottom: 5px;
    }

    .btn {
      width: 50px;
      height: 50px;
      background: rgba(0, 100, 0, 0.6);
      border: 1px solid rgba(255, 255, 0, 0.3);
      color: #ffff00;
      cursor: pointer;
      font-weight: bold;
      border-radius: 5px;
      font-size: 20px;
      touch-action: manipulation;
    }

    .btn:active {
      background: rgba(255, 255, 0, 0.3);
    }

    .join-screen {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(135deg, #1a1a2e, #16213e);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 200;
    }

    .join-panel {
      border: 2px solid #ffff00;
      padding: 30px;
      background: rgba(0, 0, 0, 0.9);
      text-align: center;
      color: #ffff00;
      font-family: 'Courier New', monospace;
    }

    .join-panel h1 {
      font-size: 32px;
      margin-bottom: 20px;
      text-shadow: 0 0 20px #ffff00;
    }

    .join-panel input {
      width: 200px;
      padding: 10px;
      margin: 10px;
      background: rgba(0, 50, 0, 0.8);
      border: 1px solid #ffff00;
      color: #ffff00;
      font-family: 'Courier New', monospace;
    }

    .join-panel button {
      padding: 10px 30px;
      margin-top: 15px;
      background: rgba(0, 100, 0, 0.8);
      border: 2px solid #ffff00;
      color: #ffff00;
      cursor: pointer;
      font-size: 16px;
      font-weight: bold;
    }

    .buy-menu {
      position: absolute;
      bottom: 110px;
      left: 10px;
      background: rgba(0, 0, 0, 0.9);
      border: 1px solid rgba(255, 255, 0, 0.3);
      padding: 10px;
      display: none;
      z-index: 100;
      max-height: 150px;
      overflow-y: auto;
      color: #ffff00;
      font-family: 'Courier New', monospace;
      font-size: 11px;
    }

    .buy-item {
      padding: 5px;
      margin: 3px 0;
      background: rgba(0, 50, 0, 0.5);
      border: 1px solid rgba(255, 255, 0, 0.2);
      cursor: pointer;
    }

    .buy-item:active {
      background: rgba(255, 255, 0, 0.2);
    }

    #fps {
      position: absolute;
      top: 10px;
      left: 10px;
      color: #00ff00;
      font-family: 'Courier New', monospace;
      font-size: 12px;
    }
  </style>
</head>
<body>
  <div class="join-screen" id="joinScreen">
    <div class="join-panel">
      <h1>‚öîÔ∏è CS MOBILE</h1>
      <p>Tactical Warfare</p>
      <input type="text" id="nickname" placeholder="Nickname" maxlength="15">
      <button onclick="startGame()">ENTER BATTLE</button>
    </div>
  </div>

  <canvas id="canvas"></canvas>

  <div id="fps">FPS: 60</div>

  <div id="topbar">
    <div class="score-display">
      ROUND <span id="roundNum">1</span>
      <span class="timer" id="timer">60:00</span>
    </div>
    <div>
      <span class="score-team-a" id="scoreA">0</span> - <span class="score-team-b" id="scoreB">0</span>
    </div>
  </div>

  <div id="teamList"></div>
  <canvas id="minimap"></canvas>

  <div id="crosshair">
    <div class="crosshair-dot"></div>
  </div>

  <div id="hud">
    <div class="hud-left">
      <div class="hud-item">$<span id="money">2400</span></div>
      <div class="hud-item">‚ù§ <span id="health">100</span>%</div>
      <div class="hud-item">üõ° <span id="armor">100</span>%</div>
    </div>
    <div class="hud-center">
      <div class="ammo-display"><span id="ammo">20</span> | <span id="clip">30</span></div>
      <div class="weapon-name" id="weaponName">Glock-18</div>
    </div>
    <div class="hud-right">
      <div class="hud-item">K: <span id="kills">0</span></div>
      <div class="hud-item">D: <span id="deaths">0</span></div>
    </div>
  </div>

  <div id="buyMenu" class="buy-menu">
    <div class="buy-item" onclick="buyWeapon('ar')">M4A1 - $3100</div>
    <div class="buy-item" onclick="buyWeapon('rifle')">AK-47 - $2900</div>
    <div class="buy-item" onclick="buyWeapon('shotgun')">XM1014 - $1200</div>
    <div class="buy-item" onclick="buyWeapon('sniper')">AWP - $4750</div>
  </div>

  <div id="controls">
    <div class="joystick-area" id="moveJoystick">
      <div class="joystick-center" id="moveStick"></div>
    </div>
    <div class="joystick-area" id="lookJoystick">
      <div class="joystick-center" id="lookStick"></div>
    </div>
    <div class="button-area">
      <button class="btn" ontouchstart="shoot()" ontouchend="">üî´</button>
      <button class="btn" id="buyBtn" ontouchstart="toggleBuy()">üõí</button>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
  <script>
    let playerId = null, gameId = 'default';
    let scene, camera, renderer, playerPos = { x: 0, y: 1.6, z: 0 };
    let playerAngle = 0, playerPitch = 0;
    let gameState = { players: [], bombPlanted: false };
    let stats = { health: 100, armor: 100, money: 2400, ammo: 20, kills: 0, deaths: 0 };
    let moveInput = { x: 0, z: 0 }, lookInput = { x: 0, y: 0 };
    let lastUpdateTime = 0;
    let fpsCounter = 0, lastFpsTime = 0;
    let playerMeshes = new Map();
    let crateInstances = null;

    async function startGame() {
      const nickname = document.getElementById('nickname').value || 'Player';
      const res = await fetch('/api/join', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ nickname, gameId })
      });
      const data = await res.json();
      playerId = data.playerId;
      gameId = data.gameId;
      stats.money = data.player.money;
      
      document.getElementById('joinScreen').style.display = 'none';
      initGame();
      gameLoop();
    }

    function initGame() {
      scene = new THREE.Scene();
      scene.background = new THREE.Color(0x87CEEB);
      scene.fog = new THREE.Fog(0x87CEEB, 300, 600);

      camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
      
      renderer = new THREE.WebGLRenderer({ canvas: document.getElementById('canvas'), antialias: false, precision: 'lowp' });
      renderer.setSize(window.innerWidth, window.innerHeight);
      renderer.setPixelRatio(Math.min(window.devicePixelRatio, 1.5));

      // Lighting - minimal for performance
      const ambLight = new THREE.AmbientLight(0xffffff, 0.8);
      scene.add(ambLight);

      // Ground
      const groundGeo = new THREE.PlaneGeometry(300, 300);
      groundGeo.dispose();
      const groundMat = new THREE.MeshBasicMaterial({ color: 0x888888 });
      const ground = new THREE.Mesh(groundGeo, groundMat);
      ground.rotation.x = -Math.PI / 2;
      scene.add(ground);

      // Buildings - low poly
      const buildingMat = new THREE.MeshBasicMaterial({ color: 0xcccccc });
      const createBuilding = (x, y, z, w, h, d) => {
        const box = new THREE.Mesh(new THREE.BoxGeometry(w, h, d), buildingMat);
        box.position.set(x, y, z);
        scene.add(box);
      };

      createBuilding(-100, 15, 0, 40, 30, 80);
      createBuilding(100, 15, 0, 40, 30, 80);
      createBuilding(0, 10, 100, 80, 20, 40);
      createBuilding(0, 10, -100, 80, 20, 40);
      createBuilding(0, 5, 0, 60, 2, 60);

      // Crates using InstancedMesh
      const crateGeo = new THREE.BoxGeometry(3, 3, 3);
      const crateMat = new THREE.MeshBasicMaterial({ color: 0x8B4513 });
      crateInstances = new THREE.InstancedMesh(crateGeo, crateMat, 8);
      
      for (let i = 0; i < 8; i++) {
        const x = (Math.random() - 0.5) * 120;
        const z = (Math.random() - 0.5) * 120;
        const matrix = new THREE.Matrix4();
        matrix.setPosition(x, 1.5, z);
        crateInstances.setMatrixAt(i, matrix);
      }
      scene.add(crateInstances);

      setupControls();
    }

    function setupControls() {
      const moveArea = document.getElementById('moveJoystick');
      const lookArea = document.getElementById('lookJoystick');

      ['touchstart', 'touchmove', 'touchend'].forEach(evt => {
        moveArea.addEventListener(evt, (e) => handleJoystick(e, moveArea, 'move'), false);
        lookArea.addEventListener(evt, (e) => handleJoystick(e, lookArea, 'look'), false);
      });

      window.addEventListener('resize', () => {
        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(window.innerWidth, window.innerHeight);
      });
    }

    function handleJoystick(e, area, type) {
      e.preventDefault();
      const touch = e.touches[0];
      if (!touch) {
        if (type === 'move') moveInput = { x: 0, z: 0 };
        else lookInput = { x: 0, y: 0 };
        document.getElementById(type === 'move' ? 'moveStick' : 'lookStick').style.transform = 'translate(-50%, -50%)';
        return;
      }

      const rect = area.getBoundingClientRect();
      const x = ((touch.clientX - rect.left) / rect.width - 0.5) * 2;
      const y = ((touch.clientY - rect.top) / rect.height - 0.5) * 2;

      if (type === 'move') moveInput = { x: x * 1.5, z: -y * 1.5 };
      else lookInput = { x: x * 0.08, y: -y * 0.08 };

      const stick = document.getElementById(type === 'move' ? 'moveStick' : 'lookStick');
      stick.style.transform = `translate(calc(-50% + ${x * 30}px), calc(-50% + ${y * 30}px))`;
    }

    async function shoot() {
      if (!playerId) return;
      const dir = new THREE.Vector3(0, 0, -1);
      dir.applyAxisAngle(new THREE.Vector3(0, 1, 0), playerAngle);
      dir.applyAxisAngle(new THREE.Vector3(1, 0, 0), playerPitch);
      
      await fetch('/api/shoot', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ playerId, dirX: dir.x, dirY: dir.y, dirZ: dir.z })
      });
    }

    async function buyWeapon(weapon) {
      const res = await fetch('/api/buy', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ playerId, weapon })
      });
      const data = await res.json();
      stats.money = data.money;
      stats.ammo = data.ammo;
      document.getElementById('weaponName').textContent = data.weaponName;
    }

    function toggleBuy() {
      const menu = document.getElementById('buyMenu');
      menu.style.display = menu.style.display === 'none' ? 'block' : 'none';
    }

    async function gameLoop() {
      const now = performance.now();
      const frameTime = now - lastUpdateTime;
      lastUpdateTime = now;

      // FPS counter
      fpsCounter++;
      if (now - lastFpsTime >= 1000) {
        document.getElementById('fps').textContent = 'FPS: ' + fpsCounter;
        fpsCounter = 0;
        lastFpsTime = now;
      }

      const speed = 0.2;
      playerPos.x += moveInput.x * speed;
      playerPos.z += moveInput.z * speed;
      playerAngle += lookInput.x;
      playerPitch = Math.max(-Math.PI / 2.2, Math.min(Math.PI / 2.2, playerPitch + lookInput.y));

      // Throttle network updates to 30Hz
      if (now % 33 < 16) {
        await fetch('/api/move', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ playerId, x: playerPos.x, y: playerPos.y, z: playerPos.z, angle: playerAngle, pitch: playerPitch })
        });
      }

      const res = await fetch(`/api/state/${gameId}`);
      const state = await res.json();
      gameState = state;

      const me = state.players.find(p => p.id === playerId);
      if (me) {
        stats.health = me.health;
        stats.armor = me.armor;
        stats.kills = me.kills;
        stats.deaths = me.deaths;
        stats.money = me.money;
        stats.ammo = me.ammo;
      }

      // Update UI
      document.getElementById('health').textContent = Math.max(0, Math.floor(stats.health));
      document.getElementById('armor').textContent = Math.max(0, Math.floor(stats.armor));
      document.getElementById('money').textContent = stats.money;
      document.getElementById('ammo').textContent = stats.ammo;
      document.getElementById('kills').textContent = stats.kills;
      document.getElementById('deaths').textContent = stats.deaths;
      document.getElementById('scoreA').textContent = state.game.teamAScore;
      document.getElementById('scoreB').textContent = state.game.teamBScore;

      // Team list - only render first 10
      const teamListHtml = '<strong style="color: #ffff00; display: block; margin-bottom: 5px;">TEAM</strong>' +
        state.teamAPlayers.slice(0, 5).map(p => `<div class="team-player ${!p.alive ? 'dead' : ''}">${p.nickname} ${p.alive ? '‚óè' : '‚úï'}</div>`).join('') +
        state.teamBPlayers.slice(0, 5).map(p => `<div class="team-player ${!p.alive ? 'dead' : ''}">${p.nickname} ${p.alive ? '‚óè' : '‚úï'}</div>`).join('');
      document.getElementById('teamList').innerHTML = teamListHtml;

      // Camera
      camera.position.copy(playerPos);
      camera.rotation.order = 'YXZ';
      camera.rotation.y = playerAngle;
      camera.rotation.x = playerPitch;

      // Remove old meshes
      for (let mesh of playerMeshes.values()) {
        scene.remove(mesh);
        mesh.geometry.dispose();
        mesh.material.dispose();
      }
      playerMeshes.clear();

      // Draw only visible players (max 8)
      const visible = state.players.filter(p => p.alive && p.id !== playerId && 
        Math.hypot(p.x - playerPos.x, p.z - playerPos.z) < 100).slice(0, 8);

      visible.forEach(p => {
        const mat = new THREE.MeshBasicMaterial({ color: p.team === 'A' ? 0xff6666 : 0x6699ff });
        const mesh = new THREE.Mesh(new THREE.BoxGeometry(0.8, 1.8, 0.8), mat);
        mesh.position.set(p.x, p.y, p.z);
        scene.add(mesh);
        playerMeshes.set(p.id, mesh);
      });

      // Minimap
      const mmCanvas = document.getElementById('minimap');
      if (mmCanvas && mmCanvas.getContext) {
        const mmCtx = mmCanvas.getContext('2d', { willReadFrequently: false });
        mmCtx.fillStyle = 'rgba(0, 0, 0, 0.7)';
        mmCtx.fillRect(0, 0, 140, 140);
        mmCtx.strokeStyle = 'rgba(255, 255, 0, 0.5)';
        mmCtx.strokeRect(0, 0, 140, 140);

        state.players.slice(0, 12).forEach(p => {
          const rx = 70 + (p.x / 150) * 60;
          const rz = 70 + (p.z / 150) * 60;
          if (p.id === playerId) {
            mmCtx.fillStyle = '#ffff00';
          } else {
            mmCtx.fillStyle = p.team === 'A' ? '#ff6666' : '#6699ff';
          }
          mmCtx.fillRect(rx - 2, rz - 2, 4, 4);
        });
      }

      renderer.render(scene, camera);
      requestAnimationFrame(gameLoop);
    }
  </script>
</body>
</html>
