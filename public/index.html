<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>FPS Arena - First Person Shooter</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Arial', sans-serif;
      background: #000;
      overflow: hidden;
      color: #0f0;
    }
    #canvas {
      display: block;
      width: 100%;
      height: 100vh;
    }
    #hud {
      position: absolute;
      bottom: 20px;
      left: 20px;
      color: #0f0;
      font-family: 'Courier New', monospace;
      font-size: 14px;
      text-shadow: 0 0 10px #0f0;
      z-index: 100;
    }
    .hud-item {
      margin: 5px 0;
      background: rgba(0, 50, 0, 0.7);
      padding: 5px 10px;
      border: 1px solid #0f0;
    }
    #crosshair {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 40px;
      height: 40px;
      border: 2px solid #0f0;
      border-radius: 50%;
      z-index: 50;
    }
    .join-screen {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(135deg, #001a00, #003300);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 200;
    }
    .join-panel {
      border: 2px solid #0f0;
      padding: 40px;
      background: rgba(0, 20, 0, 0.9);
      text-align: center;
      color: #0f0;
      font-family: 'Courier New', monospace;
    }
    .join-panel h1 {
      margin-bottom: 20px;
      text-shadow: 0 0 20px #0f0;
    }
    .join-panel input {
      width: 200px;
      padding: 10px;
      margin: 10px;
      background: rgba(0, 50, 0, 0.8);
      border: 1px solid #0f0;
      color: #0f0;
      font-family: 'Courier New', monospace;
    }
    .join-panel button {
      padding: 10px 30px;
      margin-top: 20px;
      background: rgba(0, 100, 0, 0.8);
      border: 2px solid #0f0;
      color: #0f0;
      cursor: pointer;
      font-size: 16px;
      font-family: 'Courier New', monospace;
      transition: 0.2s;
    }
    .join-panel button:hover {
      background: #0f0;
      color: #000;
      text-shadow: none;
    }
    #scoreboard {
      position: absolute;
      top: 20px;
      right: 20px;
      background: rgba(0, 50, 0, 0.8);
      border: 1px solid #0f0;
      padding: 15px;
      color: #0f0;
      font-family: 'Courier New', monospace;
      font-size: 12px;
      max-height: 300px;
      overflow-y: auto;
      z-index: 100;
    }
    .scoreboard-player {
      padding: 3px 5px;
      border-bottom: 1px solid rgba(0, 255, 0, 0.3);
    }
    #radar {
      position: absolute;
      top: 20px;
      left: 20px;
      width: 150px;
      height: 150px;
      border: 1px solid #0f0;
      background: rgba(0, 20, 0, 0.8);
      z-index: 100;
    }
  </style>
</head>
<body>
  <div class="join-screen" id="joinScreen">
    <div class="join-panel">
      <h1>⚔️ FPS ARENA</h1>
      <p>Enter your name to start</p>
      <input type="text" id="nickname" placeholder="Nickname" maxlength="20">
      <button onclick="startGame()">ENTER BATTLE</button>
    </div>
  </div>

  <canvas id="canvas"></canvas>
  
  <div id="radar"></div>
  
  <div id="crosshair"></div>
  
  <div id="hud">
    <div class="hud-item">AMMO: <span id="ammo">300</span></div>
    <div class="hud-item">HEALTH: <span id="health">100</span>/100</div>
    <div class="hud-item">KILLS: <span id="kills">0</span></div>
    <div class="hud-item">SCORE: <span id="score">0</span></div>
  </div>

  <div id="scoreboard"></div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
  <script>
    let playerId = null;
    let scene, camera, renderer;
    let playerPos = { x: 0, y: 1.6, z: 0 };
    let playerAngle = 0;
    let playerPitch = 0;
    let velocity = { x: 0, y: 0, z: 0 };
    let gameState = { players: [], enemies: [], bullets: [] };
    let localStats = { ammo: 300, health: 100, kills: 0, score: 0 };

    const keys = {};
    let mouseX = 0, mouseY = 0;

    async function startGame() {
      const nickname = document.getElementById('nickname').value || 'Player';
      const res = await fetch('/api/join', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ nickname })
      });
      const data = await res.json();
      playerId = data.playerId;
      
      document.getElementById('joinScreen').style.display = 'none';
      initGame();
      gameLoop();
    }

    function initGame() {
      scene = new THREE.Scene();
      scene.background = new THREE.Color(0x1a1a2e);
      scene.fog = new THREE.Fog(0x1a1a2e, 200, 500);

      camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
      camera.position.set(playerPos.x, playerPos.y, playerPos.z);

      renderer = new THREE.WebGLRenderer({ canvas: document.getElementById('canvas'), antialias: true });
      renderer.setSize(window.innerWidth, window.innerHeight);

      // Lighting
      const ambLight = new THREE.AmbientLight(0xffffff, 0.6);
      scene.add(ambLight);
      const dirLight = new THREE.DirectionalLight(0xffffff, 0.6);
      dirLight.position.set(50, 50, 50);
      scene.add(dirLight);

      // Ground
      const groundGeo = new THREE.PlaneGeometry(200, 200);
      const groundMat = new THREE.MeshLambertMaterial({ color: 0x2a4a2a });
      const ground = new THREE.Mesh(groundGeo, groundMat);
      ground.rotation.x = -Math.PI / 2;
      ground.position.y = 0;
      scene.add(ground);

      // Walls
      const wallMat = new THREE.MeshLambertMaterial({ color: 0x333366 });
      const wallGeo = new THREE.BoxGeometry(200, 50, 2);
      const wall1 = new THREE.Mesh(wallGeo, wallMat);
      wall1.position.set(0, 25, 100);
      scene.add(wall1);
      const wall2 = new THREE.Mesh(wallGeo, wallMat);
      wall2.position.set(0, 25, -100);
      scene.add(wall2);

      // Enemy model
      window.enemyObjects = new Map();

      window.addEventListener('keydown', (e) => keys[e.key.toLowerCase()] = true);
      window.addEventListener('keyup', (e) => keys[e.key.toLowerCase()] = false);
      window.addEventListener('mousemove', (e) => {
        mouseX = e.movementX;
        mouseY = e.movementY;
      });
      window.addEventListener('click', shoot);
      window.addEventListener('contextmenu', (e) => e.preventDefault());

      document.addEventListener('click', () => {
        renderer.domElement.requestPointerLock();
      });
    }

    async function shoot() {
      if (!playerId) return;
      
      const start = new THREE.Vector3(playerPos.x, playerPos.y, playerPos.z);
      const dir = new THREE.Vector3(0, 0, -1);
      dir.applyAxisAngle(new THREE.Vector3(0, 1, 0), playerAngle);
      dir.applyAxisAngle(new THREE.Vector3(1, 0, 0), playerPitch);

      await fetch('/api/shoot', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          playerId,
          startX: start.x,
          startY: start.y,
          startZ: start.z,
          dirX: dir.x,
          dirY: dir.y,
          dirZ: dir.z
        })
      });
      localStats.ammo--;
    }

    async function gameLoop() {
      // Input
      const speed = 0.3;
      if (keys['w']) {
        playerPos.x -= Math.sin(playerAngle) * speed;
        playerPos.z -= Math.cos(playerAngle) * speed;
      }
      if (keys['s']) {
        playerPos.x += Math.sin(playerAngle) * speed;
        playerPos.z += Math.cos(playerAngle) * speed;
      }
      if (keys['a']) {
        playerPos.x -= Math.cos(playerAngle) * speed;
        playerPos.z += Math.sin(playerAngle) * speed;
      }
      if (keys['d']) {
        playerPos.x += Math.cos(playerAngle) * speed;
        playerPos.z -= Math.sin(playerAngle) * speed;
      }

      playerAngle -= mouseX * 0.003;
      playerPitch -= mouseY * 0.003;
      playerPitch = Math.max(-Math.PI / 2, Math.min(Math.PI / 2, playerPitch));
      mouseX = 0;
      mouseY = 0;

      // Send state
      await fetch('/api/move', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          playerId,
          x: playerPos.x,
          y: playerPos.y,
          z: playerPos.z,
          angle: playerAngle,
          pitch: playerPitch
        })
      });

      // Get state
      const res = await fetch('/api/state');
      const state = await res.json();
      gameState = state;

      // Update camera
      camera.position.copy(playerPos);
      camera.rotation.order = 'YXZ';
      camera.rotation.y = playerAngle;
      camera.rotation.x = playerPitch;

      // Clear old objects
      scene.children = scene.children.filter(obj => {
        if (obj.name && (obj.name.startsWith('enemy') || obj.name.startsWith('bullet'))) {
          scene.remove(obj);
          return false;
        }
        return true;
      });

      // Draw enemies
      gameState.enemies.forEach(e => {
        const geo = new THREE.BoxGeometry(1, 2, 1);
        const mat = new THREE.MeshLambertMaterial({ color: 0xff4444 });
        const mesh = new THREE.Mesh(geo, mat);
        mesh.position.set(e.x, e.y, e.z);
        mesh.name = 'enemy_' + e.id;
        scene.add(mesh);
      });

      // Draw bullets
      gameState.bullets.forEach(b => {
        const geo = new THREE.SphereGeometry(0.1, 4, 4);
        const mat = new THREE.MeshBasicMaterial({ color: 0xffff00 });
        const mesh = new THREE.Mesh(geo, mat);
        mesh.position.set(b.x, b.y, b.z);
        mesh.name = 'bullet_' + Math.random();
        scene.add(mesh);
      });

      // Update HUD
      document.getElementById('ammo').textContent = localStats.ammo;
      document.getElementById('kills').textContent = localStats.kills;
      document.getElementById('score').textContent = localStats.score;

      const me = gameState.players.find(p => p.id === playerId);
      if (me) {
        localStats.health = me.health;
        localStats.kills = me.kills;
        localStats.score = me.score;
        document.getElementById('health').textContent = Math.max(0, me.health);
      }

      // Scoreboard
      const sorted = gameState.players.sort((a, b) => b.score - a.score);
      document.getElementById('scoreboard').innerHTML = '<strong>LEADERBOARD</strong><br>' + 
        sorted.slice(0, 5).map(p => `<div class="scoreboard-player">${p.nickname} - ${p.score}</div>`).join('');

      // Radar
      const radar = document.getElementById('radar');
      const radarCtx = radar.getContext ? radar.getContext('2d') : null;
      if (radarCtx) {
        radarCtx.fillStyle = 'rgba(0, 20, 0, 0.8)';
        radarCtx.fillRect(0, 0, 150, 150);
        radarCtx.strokeStyle = '#0f0';
        radarCtx.strokeRect(0, 0, 150, 150);

        gameState.enemies.slice(0, 10).forEach(e => {
          const rx = 75 + (e.x / 100) * 70;
          const rz = 75 + (e.z / 100) * 70;
          radarCtx.fillStyle = '#f00';
          radarCtx.fillRect(rx - 2, rz - 2, 4, 4);
        });

        radarCtx.fillStyle = '#0f0';
        radarCtx.fillRect(73, 73, 4, 4);
      }

      renderer.render(scene, camera);
      requestAnimationFrame(gameLoop);
    }

    window.addEventListener('resize', () => {
      if (renderer) {
        renderer.setSize(window.innerWidth, window.innerHeight);
        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();
      }
    });
  </script>
</body>
</html>
