<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, user-scalable=no">
  <title>CS Mobile - Tactical FPS</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; -webkit-user-select: none; user-select: none; }
    html, body { width: 100%; height: 100%; overflow: hidden; }
    body { font-family: Arial, sans-serif; background: #000; }
    #canvas { display: block; width: 100%; height: 100%; touch-action: none; }
    
    .ui-layer { position: absolute; z-index: 100; color: #0f0; font-family: 'Courier New', monospace; text-shadow: 0 0 5px #0f0; }
    #hud { top: 10px; left: 10px; font-size: 12px; }
    .hud-row { margin: 4px 0; background: rgba(0, 30, 0, 0.7); padding: 3px 6px; border: 1px solid #0f0; }
    
    #minimap { bottom: 60px; right: 10px; width: 120px; height: 120px; background: rgba(0, 0, 0, 0.8); border: 2px solid #0f0; }
    
    #controls {
      bottom: 0; left: 0; right: 0; width: 100%;
      display: flex; justify-content: space-between; align-items: flex-end;
      height: 80px; background: rgba(0, 0, 0, 0.5); border-top: 1px solid #0f0;
    }
    
    .joystick-area {
      width: 100px; height: 100px; position: relative; margin: 10px;
      background: rgba(0, 50, 0, 0.5); border: 1px solid #0f0;
    }
    .joystick-center { position: absolute; width: 30px; height: 30px; background: #0f0; border-radius: 50%; }
    
    .button-area {
      margin: 10px; display: flex; gap: 5px;
    }
    .btn {
      width: 50px; height: 50px; background: rgba(0, 100, 0, 0.7); border: 1px solid #0f0;
      color: #0f0; cursor: pointer; font-weight: bold; border-radius: 5px;
      touch-action: manipulation; -webkit-touch-callout: none;
    }
    .btn:active { background: #0f0; color: #000; }
    
    .join-screen {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: linear-gradient(135deg, #001a00, #003300);
      display: flex; justify-content: center; align-items: center;
      z-index: 200;
    }
    .join-panel {
      border: 2px solid #0f0; padding: 20px; background: rgba(0, 20, 0, 0.95);
      text-align: center; color: #0f0; font-family: 'Courier New', monospace;
    }
    .join-panel h1 { margin-bottom: 15px; font-size: 24px; }
    .join-panel input {
      width: 150px; padding: 8px; margin: 8px; background: rgba(0, 50, 0, 0.8);
      border: 1px solid #0f0; color: #0f0; font-family: 'Courier New', monospace;
    }
    .join-panel button {
      padding: 8px 20px; margin-top: 10px; background: rgba(0, 100, 0, 0.8);
      border: 1px solid #0f0; color: #0f0; cursor: pointer; font-weight: bold;
    }
    
    #shop {
      position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
      background: rgba(0, 20, 0, 0.95); border: 2px solid #0f0; padding: 15px;
      max-height: 80vh; overflow-y: auto; display: none; z-index: 150; color: #0f0;
      font-family: 'Courier New', monospace; font-size: 12px;
    }
    .shop-item { padding: 5px; margin: 5px 0; background: rgba(0, 50, 0, 0.5); border: 1px solid #0f0; cursor: pointer; }
    .shop-item:active { background: #0f0; color: #000; }
  </style>
</head>
<body>
  <div class="join-screen" id="joinScreen">
    <div class="join-panel">
      <h1>CS MOBILE</h1>
      <input type="text" id="nickname" placeholder="Nickname" maxlength="15">
      <button onclick="startGame()">PLAY</button>
    </div>
  </div>

  <canvas id="canvas"></canvas>

  <div id="hud" class="ui-layer">
    <div class="hud-row">HP: <span id="health">100</span>/100</div>
    <div class="hud-row">$: <span id="money">2400</span></div>
    <div class="hud-row" id="ammoDisplay">AMMO: 20</div>
    <div class="hud-row">K: <span id="kills">0</span> D: <span id="deaths">0</span></div>
    <div class="hud-row" id="bombStatus"></div>
  </div>

  <canvas id="minimap" class="ui-layer"></canvas>

  <div id="shop" class="ui-layer">
    <h3>SHOP</h3>
    <div class="shop-item" onclick="buyWeapon('rifle')">RIFLE $2900</div>
    <div class="shop-item" onclick="buyWeapon('shotgun')">SHOTGUN $1200</div>
    <div class="shop-item" onclick="buyWeapon('sniper')">SNIPER $4750</div>
  </div>

  <div id="controls">
    <div class="joystick-area" id="moveJoystick">
      <div class="joystick-center" id="moveStick" style="left: 35px; top: 35px;"></div>
    </div>
    <div class="joystick-area" id="lookJoystick">
      <div class="joystick-center" id="lookStick" style="left: 35px; top: 35px;"></div>
    </div>
    <div class="button-area">
      <button class="btn" id="shootBtn" ontouchstart="shoot()" ontouchend="">ðŸ”«</button>
      <button class="btn" id="shopBtn" ontouchstart="toggleShop()">ðŸ›’</button>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
  <script>
    let playerId = null, gameId = 'default';
    let scene, camera, renderer, playerPos = { x: 0, y: 2, z: 0 };
    let playerAngle = 0, playerPitch = 0;
    let gameState = { players: [], bombPlanted: false };
    let stats = { health: 100, money: 2400, ammo: 20, kills: 0, deaths: 0 };
    
    let moveInput = { x: 0, z: 0 }, lookInput = { x: 0, y: 0 };

    async function startGame() {
      const nickname = document.getElementById('nickname').value || 'Player';
      const res = await fetch('/api/join', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ nickname, gameId })
      });
      const data = await res.json();
      playerId = data.playerId;
      gameId = data.gameId;
      stats.money = data.player.money;
      
      document.getElementById('joinScreen').style.display = 'none';
      initGame();
      gameLoop();
    }

    function initGame() {
      scene = new THREE.Scene();
      scene.background = new THREE.Color(0x1a1a2e);
      scene.fog = new THREE.Fog(0x1a1a2e, 300, 500);

      camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
      
      renderer = new THREE.WebGLRenderer({ canvas: document.getElementById('canvas'), antialias: true });
      renderer.setSize(window.innerWidth, window.innerHeight);
      renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));

      // Lighting
      scene.add(new THREE.AmbientLight(0xffffff, 0.6));
      const dirLight = new THREE.DirectionalLight(0xffffff, 0.6);
      dirLight.position.set(50, 50, 50);
      scene.add(dirLight);

      // Ground
      const groundGeo = new THREE.PlaneGeometry(200, 200);
      const groundMat = new THREE.MeshLambertMaterial({ color: 0x2a3a2a });
      const ground = new THREE.Mesh(groundGeo, groundMat);
      ground.rotation.x = -Math.PI / 2;
      scene.add(ground);

      // Map structures
      const boxMat = new THREE.MeshLambertMaterial({ color: 0x444466 });
      const createBox = (x, y, z, w, h, d) => {
        const box = new THREE.Mesh(new THREE.BoxGeometry(w, h, d), boxMat);
        box.position.set(x, y, z);
        scene.add(box);
      };
      
      createBox(-50, 10, 0, 15, 20, 80);
      createBox(50, 10, 0, 15, 20, 80);
      createBox(0, 10, 50, 80, 20, 15);
      createBox(0, 10, -50, 80, 20, 15);
      createBox(0, 5, 0, 30, 3, 30);

      setupControls();
    }

    function setupControls() {
      const moveArea = document.getElementById('moveJoystick');
      const lookArea = document.getElementById('lookJoystick');

      ['touchstart', 'touchmove', 'touchend'].forEach(evt => {
        moveArea.addEventListener(evt, (e) => handleJoystick(e, moveArea, 'move'), false);
        lookArea.addEventListener(evt, (e) => handleJoystick(e, lookArea, 'look'), false);
      });

      window.addEventListener('resize', () => {
        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(window.innerWidth, window.innerHeight);
      });
    }

    function handleJoystick(e, area, type) {
      e.preventDefault();
      const touch = e.touches[0];
      if (!touch) {
        if (type === 'move') moveInput = { x: 0, z: 0 };
        else lookInput = { x: 0, y: 0 };
        return;
      }

      const rect = area.getBoundingClientRect();
      const x = (touch.clientX - rect.left) / rect.width - 0.5;
      const y = (touch.clientY - rect.top) / rect.height - 0.5;

      if (type === 'move') moveInput = { x: x * 2, z: -y * 2 };
      else lookInput = { x: x * 0.1, y: -y * 0.1 };

      const stick = type === 'move' ? document.getElementById('moveStick') : document.getElementById('lookStick');
      stick.style.left = (50 + x * 35) + 'px';
      stick.style.top = (50 + y * 35) + 'px';
    }

    async function shoot() {
      if (!playerId) return;
      const dir = new THREE.Vector3(0, 0, -1);
      dir.applyAxisAngle(new THREE.Vector3(0, 1, 0), playerAngle);
      dir.applyAxisAngle(new THREE.Vector3(1, 0, 0), playerPitch);
      
      await fetch('/api/shoot', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ playerId, dirX: dir.x, dirY: dir.y, dirZ: dir.z })
      });
    }

    async function buyWeapon(weapon) {
      const res = await fetch('/api/buy', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ playerId, weapon })
      });
      const data = await res.json();
      stats.money = data.money;
      stats.ammo = data.ammo;
    }

    function toggleShop() {
      const shop = document.getElementById('shop');
      shop.style.display = shop.style.display === 'none' ? 'block' : 'none';
    }

    async function gameLoop() {
      const speed = 0.25;
      playerPos.x += moveInput.x * speed;
      playerPos.z += moveInput.z * speed;
      playerAngle += lookInput.x;
      playerPitch = Math.max(-Math.PI / 2, Math.min(Math.PI / 2, playerPitch + lookInput.y));

      await fetch('/api/move', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ playerId, x: playerPos.x, y: playerPos.y, z: playerPos.z, angle: playerAngle, pitch: playerPitch })
      });

      const res = await fetch(`/api/state/${gameId}`);
      const state = await res.json();
      gameState = state;

      const me = state.players.find(p => p.id === playerId);
      if (me) {
        stats.health = me.health;
        stats.kills = me.kills;
        stats.deaths = me.deaths;
        stats.money = me.money;
        stats.ammo = me.ammo;
      }

      // Update UI
      document.getElementById('health').textContent = Math.max(0, stats.health);
      document.getElementById('money').textContent = stats.money;
      document.getElementById('ammoDisplay').textContent = `AMMO: ${stats.ammo}`;
      document.getElementById('kills').textContent = stats.kills;
      document.getElementById('deaths').textContent = stats.deaths;
      document.getElementById('bombStatus').textContent = state.bombPlanted ? 'ðŸ’£ BOMB!' : '';

      // Camera
      camera.position.copy(playerPos);
      camera.rotation.order = 'YXZ';
      camera.rotation.y = playerAngle;
      camera.rotation.x = playerPitch;

      // Clear objects
      scene.children = scene.children.filter(obj => {
        if (obj.name && (obj.name.startsWith('enemy') || obj.name.startsWith('bomb'))) {
          scene.remove(obj);
          return false;
        }
        return true;
      });

      // Draw players
      state.players.forEach(p => {
        if (!p.alive || p.id === playerId) return;
        const mat = new THREE.MeshLambertMaterial({ color: p.team === 'A' ? 0xff6666 : 0x6699ff });
        const mesh = new THREE.Mesh(new THREE.BoxGeometry(0.8, 1.8, 0.8), mat);
        mesh.position.set(p.x, p.y, p.z);
        mesh.name = 'enemy_' + p.id;
        scene.add(mesh);
      });

      // Draw bomb
      if (state.bombPlanted) {
        const bombMat = new THREE.MeshBasicMaterial({ color: 0xff0000 });
        const bomb = new THREE.Mesh(new THREE.SphereGeometry(0.5, 8, 8), bombMat);
        bomb.position.set(state.bombPos.x, state.bombPos.y, state.bombPos.z);
        bomb.name = 'bomb';
        scene.add(bomb);
      }

      // Minimap
      const mmCanvas = document.getElementById('minimap');
      if (mmCanvas) {
        const mmCtx = mmCanvas.getContext('2d');
        mmCtx.fillStyle = 'rgba(0, 0, 0, 0.8)';
        mmCtx.fillRect(0, 0, 120, 120);
        mmCtx.strokeStyle = '#0f0';
        mmCtx.strokeRect(0, 0, 120, 120);

        state.players.slice(0, 10).forEach(p => {
          const rx = 60 + (p.x / 100) * 50;
          const rz = 60 + (p.z / 100) * 50;
          mmCtx.fillStyle = p.team === 'A' ? '#ff6666' : '#6699ff';
          mmCtx.fillRect(rx - 2, rz - 2, 4, 4);
        });

        mmCtx.fillStyle = '#0f0';
        mmCtx.fillRect(58, 58, 4, 4);
      }

      renderer.render(scene, camera);
      requestAnimationFrame(gameLoop);
    }
  </script>
</body>
</html>
