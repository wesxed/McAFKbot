<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Tactical Arena - Team Battle</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Arial', sans-serif;
      background: linear-gradient(135deg, #1a1a2e, #16213e);
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      color: #fff;
    }
    .container {
      width: 100%;
      max-width: 1200px;
      padding: 20px;
    }
    .header {
      text-align: center;
      margin-bottom: 20px;
    }
    .header h1 {
      font-size: 2.5em;
      background: linear-gradient(90deg, #00d4ff, #0099ff);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      margin-bottom: 10px;
    }
    .game-area {
      display: flex;
      gap: 20px;
    }
    canvas {
      border: 3px solid #00d4ff;
      background: #0a0e27;
      border-radius: 8px;
      flex: 1;
      display: block;
      max-width: 1000px;
    }
    .sidebar {
      width: 250px;
      background: rgba(0, 20, 40, 0.8);
      border: 2px solid #0099ff;
      border-radius: 8px;
      padding: 15px;
      display: flex;
      flex-direction: column;
      gap: 15px;
    }
    .panel {
      background: rgba(0, 50, 100, 0.5);
      padding: 12px;
      border-radius: 6px;
      border-left: 3px solid #00d4ff;
    }
    .panel h3 {
      color: #00d4ff;
      font-size: 0.9em;
      margin-bottom: 8px;
      text-transform: uppercase;
    }
    .stat {
      font-size: 0.85em;
      margin: 5px 0;
      color: #aaa;
    }
    .stat-value {
      color: #fff;
      font-weight: bold;
    }
    .team-red { color: #ff4444; }
    .team-blue { color: #4488ff; }
    input, button {
      width: 100%;
      padding: 10px;
      margin: 5px 0;
      border: 1px solid #0099ff;
      background: rgba(0, 150, 255, 0.1);
      color: #fff;
      border-radius: 4px;
      cursor: pointer;
      transition: 0.2s;
    }
    button:hover {
      background: rgba(0, 150, 255, 0.3);
      border-color: #00d4ff;
    }
    .join-section {
      display: none;
    }
    .join-section.active {
      display: block;
    }
    .scoreboard {
      max-height: 200px;
      overflow-y: auto;
      font-size: 0.8em;
    }
    .player-item {
      padding: 5px;
      background: rgba(0, 100, 200, 0.2);
      margin: 3px 0;
      border-radius: 3px;
    }
    .loading {
      text-align: center;
      font-size: 0.9em;
      color: #888;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>‚öîÔ∏è TACTICAL ARENA</h1>
      <p>Team-based strategic combat</p>
    </div>

    <div class="game-area">
      <canvas id="gameCanvas" width="1000" height="600"></canvas>
      
      <div class="sidebar">
        <div class="join-section active" id="joinSection">
          <div class="panel">
            <h3>Join Game</h3>
            <input type="text" id="nickname" placeholder="Your nickname" maxlength="15">
            <select id="team" style="width: 100%; padding: 8px; background: rgba(0, 150, 255, 0.1); border: 1px solid #0099ff; color: #fff;">
              <option value="auto">Random Team</option>
              <option value="red">Red Team</option>
              <option value="blue">Blue Team</option>
            </select>
            <button onclick="joinGame()">JOIN BATTLE</button>
          </div>
        </div>

        <div class="panel" id="statsPanel" style="display: none;">
          <h3>Your Stats</h3>
          <div class="stat">Health: <span class="stat-value" id="health">100</span>/100</div>
          <div class="stat">Ammo: <span class="stat-value" id="ammo">120</span></div>
          <div class="stat">Kills: <span class="stat-value" id="kills">0</span></div>
          <div class="stat">Deaths: <span class="stat-value" id="deaths">0</span></div>
          <div class="stat">Team: <span id="teamDisplay"></span></div>
        </div>

        <div class="panel">
          <h3>Leaderboard</h3>
          <div class="scoreboard" id="scoreboard">
            <div class="loading">Waiting for players...</div>
          </div>
        </div>

        <div class="panel">
          <h3>Controls</h3>
          <small>
            üéÆ WASD - Move<br>
            üñ±Ô∏è Mouse - Aim<br>
            üî´ Click - Shoot<br>
            <br>
            Destroy enemy team!
          </small>
        </div>
      </div>
    </div>
  </div>

  <script>
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    
    let playerId = null;
    let playerTeam = null;
    let gameRunning = false;
    let players = [];
    let bullets = [];
    let playerStats = { health: 100, ammo: 120, kills: 0, deaths: 0 };
    
    const keys = { w: false, a: false, s: false, d: false };
    let mouseX = canvas.width / 2;
    let mouseY = canvas.height / 2;

    window.addEventListener('keydown', (e) => {
      if (e.key.toLowerCase() === 'w') keys.w = true;
      if (e.key.toLowerCase() === 'a') keys.a = true;
      if (e.key.toLowerCase() === 's') keys.s = true;
      if (e.key.toLowerCase() === 'd') keys.d = true;
    });

    window.addEventListener('keyup', (e) => {
      if (e.key.toLowerCase() === 'w') keys.w = false;
      if (e.key.toLowerCase() === 'a') keys.a = false;
      if (e.key.toLowerCase() === 's') keys.s = false;
      if (e.key.toLowerCase() === 'd') keys.d = false;
    });

    canvas.addEventListener('mousemove', (e) => {
      const rect = canvas.getBoundingClientRect();
      mouseX = e.clientX - rect.left;
      mouseY = e.clientY - rect.top;
    });

    canvas.addEventListener('click', shoot);

    async function joinGame() {
      const nickname = document.getElementById('nickname').value || 'Player';
      const team = document.getElementById('team').value;
      
      if (!nickname) return;

      const res = await fetch('/api/join', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ nickname, team })
      });

      const data = await res.json();
      playerId = data.playerId;
      playerTeam = data.player.team;
      gameRunning = true;
      
      document.getElementById('joinSection').style.display = 'none';
      document.getElementById('statsPanel').style.display = 'block';
      document.getElementById('teamDisplay').innerHTML = `<span class="team-${playerTeam}">${playerTeam.toUpperCase()}</span>`;
      
      gameLoop();
    }

    async function shoot() {
      if (!gameRunning || !playerId) return;
      
      const angle = Math.atan2(mouseY - 300, mouseX - 500);
      await fetch('/api/shoot', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ playerId, angle })
      });
    }

    async function gameLoop() {
      const res = await fetch('/api/state');
      const state = await res.json();
      players = state.players;
      bullets = state.bullets;

      const me = players.find(p => p.id === playerId);
      if (me) {
        playerStats.health = me.health;
        playerStats.ammo = me.ammo;
        playerStats.kills = me.kills;
        playerStats.deaths = me.deaths;

        let nx = me.x;
        let ny = me.y;
        if (keys.w) ny -= 4;
        if (keys.s) ny += 4;
        if (keys.a) nx -= 4;
        if (keys.d) nx += 4;

        await fetch('/api/move', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ playerId, x: nx, y: ny, angle: Math.atan2(mouseY - me.y, mouseX - me.x) })
        });
      }

      updateUI();
      draw(me);

      if (gameRunning) setTimeout(gameLoop, 30);
    }

    function updateUI() {
      document.getElementById('health').textContent = Math.max(0, playerStats.health);
      document.getElementById('ammo').textContent = playerStats.ammo;
      document.getElementById('kills').textContent = playerStats.kills;
      document.getElementById('deaths').textContent = playerStats.deaths;

      const sorted = [...players].sort((a, b) => b.kills - a.kills);
      const scoreHTML = sorted.slice(0, 10).map(p => 
        `<div class="player-item"><span class="team-${p.team}">${p.nickname}</span> ${p.kills}K-${p.deaths}D ${p.health}‚ù§</div>`
      ).join('');
      document.getElementById('scoreboard').innerHTML = scoreHTML || 'No players';
    }

    function draw(me) {
      ctx.fillStyle = '#0a0e27';
      ctx.fillRect(0, 0, canvas.width, canvas.height);

      // Grid
      ctx.strokeStyle = 'rgba(0, 100, 200, 0.1)';
      ctx.lineWidth = 1;
      for (let i = 0; i < canvas.width; i += 50) {
        ctx.beginPath();
        ctx.moveTo(i, 0);
        ctx.lineTo(i, canvas.height);
        ctx.stroke();
      }
      for (let i = 0; i < canvas.height; i += 50) {
        ctx.beginPath();
        ctx.moveTo(0, i);
        ctx.lineTo(canvas.width, i);
        ctx.stroke();
      }

      // Team zones
      ctx.fillStyle = 'rgba(255, 68, 68, 0.05)';
      ctx.fillRect(0, 0, 200, canvas.height);
      ctx.fillStyle = 'rgba(68, 136, 255, 0.05)';
      ctx.fillRect(canvas.width - 200, 0, 200, canvas.height);

      // Players
      players.forEach(p => {
        if (!p.alive) return;
        ctx.fillStyle = p.team === 'red' ? '#ff6666' : '#6699ff';
        ctx.beginPath();
        ctx.arc(p.x, p.y, 15, 0, Math.PI * 2);
        ctx.fill();

        // Aim line
        if (p.id === playerId) {
          ctx.strokeStyle = 'rgba(0, 212, 255, 0.5)';
          ctx.lineWidth = 2;
          ctx.beginPath();
          ctx.moveTo(p.x, p.y);
          ctx.lineTo(p.x + Math.cos(p.angle) * 100, p.y + Math.sin(p.angle) * 100);
          ctx.stroke();
        }

        // Health bar
        ctx.fillStyle = '#222';
        ctx.fillRect(p.x - 15, p.y - 25, 30, 5);
        ctx.fillStyle = p.health > 50 ? '#66ff66' : '#ffaa00';
        ctx.fillRect(p.x - 15, p.y - 25, (p.health / 100) * 30, 5);

        ctx.fillStyle = '#fff';
        ctx.font = '10px Arial';
        ctx.textAlign = 'center';
        ctx.fillText(p.nickname, p.x, p.y + 25);
      });

      // Bullets
      bullets.forEach(b => {
        ctx.fillStyle = '#ffff00';
        ctx.beginPath();
        ctx.arc(b.x, b.y, 3, 0, Math.PI * 2);
        ctx.fill();
      });

      // Crosshair
      if (me) {
        ctx.strokeStyle = 'rgba(0, 212, 255, 0.7)';
        ctx.lineWidth = 2;
        ctx.beginPath();
        ctx.arc(mouseX, mouseY, 20, 0, Math.PI * 2);
        ctx.stroke();
      }
    }
  </script>
</body>
</html>
